<ng-container *ngIf="isOpen$ | async">
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal-window" (click)="$event.stopPropagation()">
      <div class="modal-container">

        <ng-container *ngIf="isSuccess; else formTemplate">
          <div class="success-block">
            <h2 class="modal-title">Спасибо за вашу заявку!</h2>
            <p class="modal-text">Мы свяжемся с вами при первой же возможности.</p>
            <button class="button" (click)="closeModal()">Окей</button>
          </div>
        </ng-container>

        <ng-template #formTemplate>
          <h2 class="modal-title">
            {{ modalType === 'callback' ? 'Бесплатная консультация' : 'Оставьте заявку' }}
          </h2>

          <form [formGroup]="form" (ngSubmit)="onSubmit()" class="modal-form">

            <div class="select-wrap"
                 *ngIf="modalType !== 'callback'"
                 [class.invalid]="form.get('service')?.invalid && form.get('service')?.touched">

              <button
                type="button"
                class="select-control"
                (click)="toggleDropdown()">
                <span>{{ form.value.service || 'Выберите услугу' }}</span>
              </button>

              <div class="select-menu" *ngIf="dropdownOpen">
                <div
                  *ngFor="let serviceName of services"
                  (mousedown)="selectService(serviceName)">
                  {{ serviceName }}
                </div>

              </div>
            </div>

            <div class="error"
                 *ngIf="modalType !== 'callback' && form.get('service')?.touched && form.get('service')?.invalid">
              Выберите услугу
            </div>

            <input
              type="text"
              placeholder="Ваше имя"
              formControlName="name"
              [class.invalid]="form.get('name')?.invalid && form.get('name')?.touched" />

            <div class="error" *ngIf="form.get('name')?.touched && form.get('name')?.invalid">
              <span *ngIf="form.get('name')?.errors?.['required']">Имя обязательно</span>
              <span *ngIf="form.get('name')?.errors?.['pattern']">Только буквы, без цифр</span>
            </div>

            <input
              type="tel"
              placeholder="Ваш телефон"
              formControlName="phone"
              [class.invalid]="form.get('phone')?.invalid && form.get('phone')?.touched" />

            <div class="error" *ngIf="form.get('phone')?.touched && form.get('phone')?.invalid">
              <span *ngIf="form.get('phone')?.errors?.['required']">Телефон обязателен</span>
              <span *ngIf="form.get('phone')?.errors?.['pattern']">Введите корректный номер телефона</span>
            </div>

            <button
              type="submit"
              class="submit-btn"
              [disabled]="form.invalid || loading">
              {{ loading ? 'Отправка...' : (modalType === 'callback' ? 'Заказать звонок' : 'Отправить') }}
            </button>

            <div *ngIf="isError" class="error-message">
              Произошла ошибка при отправке формы, попробуйте ещё раз.
            </div>
          </form>
        </ng-template>

      </div>
    </div>
  </div>
</ng-container>
