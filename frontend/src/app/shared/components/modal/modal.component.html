<ng-container *ngIf="isOpen$ | async">
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal-window" (click)="$event.stopPropagation()">
      <div class="modal-container">

        <ng-container *ngIf="isSuccess; else formTemplate">
          <div class="success-block">
            <h2 class="modal-title">Спасибо за вашу заявку!</h2>
            <p class="modal-text">Мы свяжемся с вами при первой же возможности.</p>
            <button class="button" (click)="closeModal()">Окей</button>
          </div>
        </ng-container>

        <ng-template #formTemplate>
          <h2 class="modal-title">
            {{ modalType === 'callback' ? 'Бесплатная консультация' : 'Оставьте заявку' }}
          </h2>

          <form [formGroup]="form" (ngSubmit)="onSubmit()" class="modal-form">
            <div class="select-wrap"
                 *ngIf="modalType !== 'callback'"
                 [class.invalid]="form.get('service')?.invalid && form.get('service')?.touched">
              <button
                type="button"
                class="select-control"
                (click)="toggleDropdown()"
                (keydown)="onKeydown($event)"
                [attr.aria-expanded]="dropdownOpen"
                aria-haspopup="listbox">
                <span>{{ form.value.service || 'Выберите услугу' }}</span>
                <svg class="caret" viewBox="0 0 20 20" width="16" height="16" aria-hidden="true">
                  <path d="M5 7l5 6 5-6z"></path>
                </svg>
              </button>

              <div class="select-menu" *ngIf="dropdownOpen" role="listbox">
                <div
                  *ngFor="let s of services; let i = index"
                  class="option"
                  role="option"
                  [attr.aria-selected]="form.value.service === s"
                  [class.selected]="form.value.service === s"
                  (mouseenter)="focusedIndex = i"
                  (mousedown)="selectService(s)">
                  {{ s }}
                </div>
              </div>
            </div>

            <input
              type="text"
              placeholder="Ваше имя"
              formControlName="name"
              [class.invalid]="form.get('name')?.invalid && form.get('name')?.touched" />

            <input
              type="tel"
              placeholder="Ваш телефон"
              formControlName="phone"
              [class.invalid]="form.get('phone')?.invalid && form.get('phone')?.touched" />

            <button
              type="submit"
              class="submit-btn"
              [disabled]="form.invalid || loading">
              {{ loading ? 'Отправка...' : (modalType === 'callback' ? 'Заказать звонок' : 'Отправить') }}
            </button>

            <div *ngIf="isError" class="error-message">
              Произошла ошибка при отправке формы, попробуйте ещё раз.
            </div>
          </form>
        </ng-template>

      </div>
    </div>
  </div>
</ng-container>

